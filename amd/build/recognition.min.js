/**
 * Javascript to initialise the recognition of a student facial expression.
 *
 * @module     block_emotionanalysis/recognition
 * @copyright  2023 Rohit <rx18008@edu.rta.lv>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_emotionanalysis/recognition",["jquery","core/ajax","core/url","./youTubeManager","core/str"],(function($,Ajax,url,youTubeManager,String){let predictedEmotion,videoElement,videoWatchTime,camArea=document.getElementById("live-view"),modelLoadedStatus=!1,modelsUrl=url.fileUrl("/blocks/emotionanalysis/thirdpartylibs/models","");Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri(modelsUrl),faceapi.nets.faceLandmark68Net.loadFromUri(modelsUrl),faceapi.nets.faceRecognitionNet.loadFromUri(modelsUrl),faceapi.nets.faceExpressionNet.loadFromUri(modelsUrl),faceapi.nets.ageGenderNet.loadFromUri(modelsUrl),faceapi.nets.ssdMobilenetv1.loadFromUri(modelsUrl)]).then((function(){modelLoadedStatus=!0}));const categorizedEmotions={positive:0,neutral:0,negative:0},happySegment=document.getElementById("happy-segment"),neutralSegment=document.getElementById("neutral-segment"),sadSegment=document.getElementById("sad-segment");happySegment.style.backgroundColor="blue",neutralSegment.style.backgroundColor="yellow",sadSegment.style.backgroundColor="red";happySegment.style.height="20px",neutralSegment.style.height="20px",sadSegment.style.height="20px";let detectionInterval;happySegment.style.transition="width ".concat("0.5s"),neutralSegment.style.transition="width ".concat("0.5s"),sadSegment.style.transition="width ".concat("0.5s");let element=document.getElementById("mod-id"),value=parseInt(atob(element.getAttribute("value")),10);if(17===value){let iframe=document.getElementsByTagName("iframe")[0];if(iframe){iframe.setAttribute("id","another-love");let newSrc=iframe.getAttribute("src").split("?")[0]+"?enablejsapi=1";iframe.setAttribute("src",newSrc)}youTubeManager.readyPromise.then((()=>{youTubeManager.player.addEventListener("onStateChange",(event=>{event.data===YT.PlayerState.PLAYING?(enableWebCam(),videoWatchTime=youTubeManager.currentTime):2===event.data&&disableWebCam()}))})).catch((error=>{console.error(error.message)}))}else if(19===value){let videoTags=document.getElementsByTagName("video");videoElement=videoTags[1],videoElement.addEventListener("play",(()=>{videoWatchTime=videoElement.currentTime,enableWebCam()})),videoElement.addEventListener("pause",(()=>{disableWebCam()}))}return{courseId:getDecodedValue("course-id-val"),resourceId:getDecodedValue("course-module-id"),instanceId:getDecodedValue("course-instance-id"),value:value,videoElement:videoElement};function enableWebCam(){navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0}).then((function(stream){let camArea=document.getElementById("live-view");camArea.srcObject=stream,camArea.play(),captureFacialExpression()})).catch((function(){19===value?(videoElement.pause(),String.get_string("no_camera_permission","block_emotionanalysis").then((function(text){window.alert(text)}))):17===value&&(youTubeManager.player.pauseVideo(),youTubeManager.player.addEventListener("onStateChange",(function(event){event.data===YT.PlayerState.PAUSED&&(String.get_string("no_camera_permission","block_emotionanalysis").then((function(text){window.alert(text)})),camArea.srcObject=null)})))}))}function disableWebCam(){camArea.srcObject=null,clearInterval(detectionInterval)}function captureFacialExpression(){let noFaceFound,prevEmotionState;detectionInterval=setInterval((async()=>{let detections=await faceapi.detectAllFaces(camArea,new faceapi.TinyFaceDetectorOptions({scoreThreshold:.3,inputsize:320})).withFaceExpressions().withAgeAndGender();if(0===detections.length&&(detections=await faceapi.detectAllFaces(camArea,new faceapi.SsdMobilenetv1Options({scoreThreshold:.3,inputsize:320})).withFaceExpressions().withAgeAndGender()),detections.length>0){let gender=detections[0].gender,ageGroup=detections[0].age;const result=function(moduleType){if(17===moduleType)return{currentTime:youTubeManager.player.getCurrentTime(),totalDuration:youTubeManager.player.getDuration()};if(19===moduleType)return{currentTime:videoElement.currentTime,totalDuration:videoElement.duration}}(value);predictedEmotion=Object.fromEntries(Object.entries(detections[0].expressions).sort(((_ref,_ref2)=>{let[,a]=_ref,[,b]=_ref2;return b-a})));let emotionState=Object.keys(predictedEmotion)[0],secondEmotion=Object.keys(predictedEmotion)[1];"happy"===emotionState||"surprised"===emotionState&&"happy"===secondEmotion||"neutral"===emotionState&&"happy"===secondEmotion?categorizedEmotions.positive++:"neutral"===emotionState?categorizedEmotions.neutral++:categorizedEmotions.negative++;let totalEmotion=Object.values(categorizedEmotions).reduce(((acc,value)=>acc+value),0);if(requestAnimationFrame((()=>function(totalEmotion){const happySegment=document.getElementById("happy-segment"),neutralSegment=document.getElementById("neutral-segment"),sadSegment=document.getElementById("sad-segment");happySegment.style.width="".concat(categorizedEmotions.positive/totalEmotion*100,"%"),neutralSegment.style.width="".concat(categorizedEmotions.neutral/totalEmotion*100,"%"),sadSegment.style.width="".concat(categorizedEmotions.negative/totalEmotion*100,"%")}(totalEmotion))),emotionState!==prevEmotionState){let requestData={values:{emotionState:emotionState,videoTimeStamp:Math.floor(result.currentTime),courseId:getDecodedValue("course-id-val"),resourceId:getDecodedValue("course-module-id"),instanceId:getDecodedValue("course-instance-id"),totalDuration:Math.floor(result.totalDuration),videoWatchTime:Math.floor(videoWatchTime),gender:gender,ageGroup:ageGroup}};prevEmotionState=emotionState;let request={methodname:"blocks_emotionanalysis_capture_emotions",args:requestData};Ajax.call([request])[0].done((function(data){console.log(data)})).fail((function(data){console.log(data.error)})),noFaceFound=0}}else console.log("No face Found"),noFaceFound=++noFaceFound,noFaceFound>10&&(19===value?(videoElement.pause(),window.alert("we are unable to find any face Please adjust your camera or Position")):(youTubeManager.player.pauseVideo(),youTubeManager.player.addEventListener("onStateChange",(function(event){event.data===YT.PlayerState.PAUSED&&(window.alert("We are unable to find any face. Please adjust your camera or position."),camArea.srcObject=null)}))),clearInterval(detectionInterval),camArea.srcObject=null,noFaceFound=0)}),1e3)}function getDecodedValue(id){let element=document.getElementById(id);return atob(element.getAttribute("value"))}}));

//# sourceMappingURL=recognition.min.js.map